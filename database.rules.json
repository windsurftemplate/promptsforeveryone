{
  "rules": {
    "users": {
      ".read": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".indexOn": ["role", "email", "plan"],
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "email": { ".validate": "newData.isString()" },
        "role": { 
          ".validate": "newData.isString() && (newData.val() === 'admin' || newData.val() === 'user' || newData.val() === 'moderator')",
          ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'"
        },
        "plan": { 
          ".validate": "newData.isString() && (newData.val() === 'free' || newData.val() === 'pro')",
          ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'"
        },
        "isPro": { 
          ".validate": "newData.isBoolean()",
          ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'"
        },
        "stripeCustomerId": { ".validate": "newData.isString() || !newData.exists()" },
        "stripeSubscriptionId": { ".validate": "newData.isString() || !newData.exists()" },
        "stripeSubscriptionStatus": { ".validate": "newData.isString() || !newData.exists()" },
        "createdAt": { ".validate": "newData.isString()" },
        "updatedAt": { ".validate": "newData.isString()" },
        "favorites": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid"
        },
        "prompts": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid && (root.child('users').child(auth.uid).child('plan').val() === 'paid' || root.child('users').child(auth.uid).child('role').val() === 'admin')",
          ".indexOn": ["createdAt", "categoryId"],
          "$promptId": {
            ".validate": "newData.hasChildren(['title', 'description', 'content', 'categoryId', 'userId', 'createdAt'])",
            "userId": {
              ".validate": "newData.val() === auth.uid"
            },
            "title": {
              ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 100"
            },
            "description": {
              ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 500"
            },
            "content": {
              ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 5000"
            },
            "categoryId": {
              ".validate": "newData.isString()"
            },
            "visibility": {
              ".validate": "newData.isString() && (newData.val() === 'public' || newData.val() === 'private')"
            }
          }
        },
        "categories": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid && (root.child('users').child(auth.uid).child('plan').val() === 'paid' || root.child('users').child(auth.uid).child('role').val() === 'admin')",
          ".indexOn": ["name"],
          "$categoryId": {
            ".validate": "newData.hasChildren(['name'])",
            "name": {
              ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 50"
            },
            "description": {
              ".validate": "newData.isString() || !newData.exists()"
            },
            "icon": {
              ".validate": "newData.isString() || !newData.exists()"
            }
          }
        }
      }
    },
    "blog": {
      ".read": true,
      ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".indexOn": ["createdAt", "category"],
      "$postId": {
        ".validate": "newData.hasChildren(['title', 'content'])",
        "title": { ".validate": "newData.isString() && newData.val().length > 0" },
        "content": { ".validate": "newData.isString() && newData.val().length > 0" },
        "excerpt": { ".validate": "newData.isString()" },
        "author": { ".validate": "newData.isString()" },
        "date": { ".validate": "newData.isString()" },
        "category": { ".validate": "newData.isString()" },
        "readTime": { ".validate": "newData.isString()" },
        "featured": { ".validate": "newData.isBoolean()" },
        "createdAt": { ".validate": "newData.isString()" }
      }
    },
    "categories": {
      ".read": true,
      ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".indexOn": ["name"],
      "$categoryId": {
        ".validate": "newData.hasChildren(['name'])",
        "name": { ".validate": "newData.isString() && newData.val().length > 0" },
        "description": { ".validate": "newData.isString()" },
        "icon": { ".validate": "newData.isString()" }
      }
    },
    "prompts": {
      ".read": true,
      ".write": "auth != null",
      ".indexOn": ["categoryId", "userId", "visibility"],
      "$promptId": {
        ".validate": "newData.hasChildren(['title', 'description', 'content', 'categoryId', 'userId', 'createdAt'])",
        "userId": {
          ".validate": "newData.val() === auth.uid"
        },
        "title": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 100"
        },
        "description": {
          ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 500"
        },
        "content": {
          ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 5000"
        },
        "categoryId": {
          ".validate": "newData.isString() && root.child('categories').child(newData.val()).exists()"
        },
        "visibility": {
          ".validate": "newData.isString() && (newData.val() === 'public' || newData.val() === 'private')"
        }
      }
    },
    "chats": {
      ".read": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      "$uid": {
        ".read": "auth != null && ($uid === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin')",
        ".write": "auth != null && ($uid === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin')",
        ".indexOn": ["createdAt"],
        "$sessionId": {
          ".validate": "newData.hasChildren(['messages'])",
          "messages": {
            "$messageId": {
              ".validate": "newData.hasChildren(['role', 'content'])",
              "role": { ".validate": "newData.isString() && (newData.val() === 'user' || newData.val() === 'assistant')" },
              "content": { ".validate": "newData.isString()" }
            }
          },
          "title": { ".validate": "newData.isString()" },
          "lastMessage": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isString()" },
          "updatedAt": { ".validate": "newData.isString()" }
        }
      }
    },
    "howToStart": {
      ".read": true,
      ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      "content": { ".validate": "newData.isString()" },
      "updatedAt": { ".validate": "newData.isString()" },
      "updatedBy": { ".validate": "newData.isString()" }
    }
  }
}
